name: Build and Release

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-tolk:
    runs-on: windows-latest

    steps:
      - name: Clone Tolk repository
        run: git clone https://github.com/dkager/tolk.git tolk-src

      - name: Build Tolk (x64, without JNI)
        shell: cmd
        run: |
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
          cd tolk-src\src
          cl.exe /nologo /O2 /EHsc /LD /Gw /W4 /WL /D_EXPORTING /DUNICODE ^
            /Fe:Tolk.dll ^
            Tolk.cpp ^
            ScreenReaderDriverJAWS.cpp ScreenReaderDriverNVDA.cpp ^
            ScreenReaderDriverSA.cpp ScreenReaderDriverSNova.cpp ^
            ScreenReaderDriverWE.cpp ScreenReaderDriverZT.cpp ^
            ScreenReaderDriverSAPI.cpp ^
            fsapi.c wineyes.c zt.c ^
            User32.Lib Ole32.Lib OleAut32.Lib

      - name: Package Tolk x64
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path tolk-x64 -Force | Out-Null
          Copy-Item tolk-src\src\Tolk.dll tolk-x64\ -ErrorAction Stop
          Copy-Item tolk-src\libs\x64\*.dll tolk-x64\
          Compress-Archive -Path tolk-x64\* -DestinationPath tolk-x64.zip

      - name: Upload Tolk artifact
        uses: actions/upload-artifact@v4
        with:
          name: tolk-x64
          path: tolk-x64.zip

  build-and-release:
    runs-on: ubuntu-latest
    needs: build-tolk

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "6.0.x"

      - name: Restore dependencies
        run: dotnet restore TouchlineMod.sln

      - name: Build
        run: dotnet build TouchlineMod.sln -c Release --no-restore

      - name: Download Tolk artifact
        uses: actions/download-artifact@v4
        with:
          name: tolk-x64

      - name: Read version from project
        id: version
        run: |
          VERSION=$(grep '<Version>' src/TouchlineMod/TouchlineMod.csproj | sed 's/.*<Version>\(.*\)<\/Version>.*/\1/')
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Generate release tag
        id: tag
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TIMESTAMP=$(date -u +%Y%m%d%H%M%S)
          SHORT_SHA=${GITHUB_SHA::7}
          TAG="v${VERSION}+${TIMESTAMP}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "display_version=$VERSION (build $SHORT_SHA)" >> "$GITHUB_OUTPUT"

      - name: Package release
        run: |
          mkdir -p release-package
          cp src/TouchlineMod/bin/Release/net6.0/TouchlineMod.dll release-package/
          cp install.bat release-package/
          cp install.ps1 release-package/
          cp README.md release-package/
          cp INSTALL.md release-package/
          cp LICENSE release-package/
          cp tolk-x64.zip release-package/
          cd release-package
          zip -r ../Touchline-FM26-Installer.zip .

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: "Touchline v${{ steps.version.outputs.version }}"
          body: |
            ## Touchline - FM26 Accessibility Mod

            **Version**: ${{ steps.tag.outputs.display_version }}

            ### How to Install

            1. Download **Touchline-FM26-Installer.zip** below
            2. Extract the ZIP anywhere on your computer
            3. Double-click **install.bat**
            4. The installer will automatically find your FM26 game (Steam, Epic, or Xbox Game Pass) and set everything up

            That's it! Start your screen reader (NVDA or JAWS), then launch Football Manager 2026.

            ### What's Included

            - `install.bat` — Double-click this to install everything
            - `install.ps1` — PowerShell installer (called by install.bat)
            - `TouchlineMod.dll` — The accessibility mod
            - `tolk-x64.zip` — Tolk screen reader bridge (NVDA/JAWS support)
            - `README.md` — Full documentation
            - `INSTALL.md` — Detailed installation guide
            - `LICENSE` — MIT License
          files: |
            Touchline-FM26-Installer.zip
            tolk-x64.zip
          generate_release_notes: true
